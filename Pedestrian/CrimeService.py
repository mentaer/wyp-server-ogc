import json
import psycopg2
from bottle import route, run, request
import bottle

bottle.BaseRequest.MEMFILE_MAX = 1024 * 1024

#This function returns the crime happened within the given polygon
def pointInPolygon(polygon):
    import config

    connection_string = config.conf()

    conn = psycopg2.connect(connection_string)
    cur = conn.cursor()
    polygonJSON = json.loads(polygon)
    finalPolygon = "POLYGON(("
    for point in polygonJSON['coordinates'][0]:
        longitude = point[0]
        latitude = point[1]
        vertex = "%s %s" % (longitude, latitude)
        finalPolygon += "%s," % (vertex,)
    finalPolygon = finalPolygon[:-1]
    finalPolygon += "))"
    selectQuery = "SELECT id, ST_AsText(crime_location), crime_time, crime_type FROM cps_crime_data.crime_data WHERE ST_Within(crime_location, ST_GeomFromText(%s, 4326));"
    parameters = [finalPolygon]
    cur.execute(selectQuery, parameters)
    rows = cur.fetchall()
    if len(rows) > 0:
        result_json = '{"type": "FeatureCollection", "features": ['
        for i in xrange(len(rows)):
            id = rows[i][0]
            location = rows[i][1]
            location = location[6:].split(' ')
            longitude = location[0]
            latitude = location[1][:-1]
            location = "[%s,%s]" % (longitude, latitude)
            time = rows[i][2]
            time = "%s-%s-%s %s:%s:00" % (time.year, time.month, time.day, time.hour, time.minute)
            type = rows[i][3]
            result_json += '{"type": "Feature","geometry": {"type": "Point", "coordinates":%s}, "properties": {"id": %s, "time": "%s","type": "%s"}},' % (
                location, id, time, type)
        result_json = result_json[:-1]
        result_json += ']}'
    else:
        result_json = '"NULL"'
    conn.commit()
    cur.close()
    conn.close()
    return result_json


@route('/crime')
def service():
    polygon = request.GET.get('walkshed', default=None)
    if polygon is not None:
        return pointInPolygon(polygon)


run(host='0.0.0.0', port=8366, debug=True)

#http://127.0.0.1:9191/crime?walkshed={"type":"Polygon","coordinates":[[[-114.13258446221629,51.05667765949581],[-114.13254056321318,51.05780123264723],[-114.13152943754814,51.05928339714371],[-114.12950549567188,51.06011065488163],[-114.1279654,51.0595932],[-114.12445710928647,51.062350863156894],[-114.12371101357336,51.063263785101434],[-114.12310669501387,51.06399487923505],[-114.12123542899363,51.0661290239349],[-114.11806424260443,51.06644301813297],[-114.11786253384714,51.066370448767316],[-114.1164274,51.063358],[-114.1134139,51.0622939],[-114.1131162,51.0622073],[-114.1129392,51.0620646],[-114.11184,51.0609932],[-114.1073205,51.0596571],[-114.1063016,51.060466691883235],[-114.10383914444445,51.06000902380952],[-114.10321092026163,51.05965823334367],[-114.10018115215432,51.057739378598626],[-114.09998273312733,51.05760439367275],[-114.1038694944397,51.05455092810189],[-114.10400678562115,51.054463627570605],[-114.10475924522562,51.05399662522794],[-114.10556177053202,51.053499575688136],[-114.10861280557579,51.05160815940013],[-114.11152012383799,51.049742240547495],[-114.1129164,51.0497427],[-114.11648368491431,51.04959693181472],[-114.11835347765114,51.04940523337369],[-114.1215325,51.0523811],[-114.1221979,51.0527387],[-114.122947,51.053085],[-114.12355379949769,51.05334646431694],[-114.125129,51.053914],[-114.128853,51.055076],[-114.129204,51.055165],[-114.1308835,51.0556508],[-114.13194309123665,51.05595505984363],[-114.13258446221629,51.05667765949581]]]}
#http://127.0.0.1:8366/crime?walkshed={"type":"Polygon","coordinates":[[[-114.09364571378056,51.057144582993836],[-114.09286815708892,51.05359381755474],[-114.09101115708,51.050834058520664],[-114.09075927937053,51.05080998647081],[-114.0870286,51.0516827],[-114.08586777200182,51.04970977429437],[-114.0835059,51.0489783],[-114.08184778623112,51.0498709384076],[-114.081181,51.0536508],[-114.0793914,51.0547065],[-114.077687,51.0557314],[-114.0756248,51.0568823],[-114.0750158,51.0570965],[-114.0736901,51.0573512],[-114.06926177015508,51.055915080229724],[-114.06619893997784,51.05694155563417],[-114.06579011626843,51.0581622658825],[-114.067673398873,51.058916548778726],[-114.07143185670641,51.061423362491404],[-114.07184987616904,51.06168921938163],[-114.0741837,51.0613545],[-114.07794224224338,51.06228401160695],[-114.07918450576179,51.06260346516831],[-114.07993046849634,51.06280359284396],[-114.08066137191179,51.062350982627464],[-114.08244401432806,51.06127600012983],[-114.08582266933304,51.061346817139835],[-114.08616082731021,51.06129711945887],[-114.0888935,51.0575163],[-114.09170271289915,51.05843118482227],[-114.09364571378056,51.057144582993836]]]}
